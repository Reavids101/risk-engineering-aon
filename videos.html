<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>Risk Engineering Videos</title>
    <style>
        /* Add your custom styles here */
    </style>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <section class="navbar">
        <img src="/risk-engineering-aon/AON.svg">
        <h1>Risk Engineering Videos</h1>
        <a href="index.html">Home</a>
        <a href="articles.html">Articles</a>
        <a href="videos.html">Videos</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <input type="text" id="searchBox" onkeyup="filterVideos()" placeholder="Search for items...">
        <div id="player"></div>
        <div id="video-feed"></div>
        <script src="https://apis.google.com/js/api.js"></script>
        <script>
            var player;
            var videoFeedElement = document.getElementById('video-feed');
            
            // Get a list of all video files in the same directory as this webpage
            fetch('./', { mode: 'cors' })
                .then(response => response.text())
                .then(data => {
                    var parser = new DOMParser();
                    var html = parser.parseFromString(data, 'text/html');
                    var videos = Array.from(html.getElementsByTagName('a'))
                        .filter(link => /\.(mp4|avi|mov|MP4)$/.test(link.href))
                        .map(link => {
                            return {
                                id: link.href.split('/').pop().split('.')[0],
                                title: link.href.split('/').pop().split('.')[0],
                                description: '',
                                thumbnail: '',
                                duration: ''
                            };
                        });
                    
                    // Fetch video metadata using the YouTube API
                    gapi.load('client', function() {
                        gapi.client.init({
                            apiKey: 'AIzaSyDwL1VUxwHvEl-NcCnmxh2WHFAV11HueL0'
                        }).then(function() {
                            var videosList = [];
                            var promises = videos.map(function(video) {
                                return gapi.client.youtube.videos.list({
                                    'id': video.id,
                                    'part': 'snippet,contentDetails'
                                }).then(function(response) {
                                    var videoData = response.result.items[0];

                                    var videoElement = document.createElement('video');
                                    videoElement.setAttribute('src', video.id + '.mp4');
                                    videoElement.setAttribute('type', 'video/mp4');
                                    videoElement.setAttribute('controls', '');

                                    var titleElement = document.createElement('h2');
                                    titleElement.textContent = videoData.snippet.title;

                                    var descriptionElement = document.createElement('p');
                                    descriptionElement.textContent = videoData.snippet.description;

                                    var thumbnailElement = document.createElement('img');
                                    thumbnailElement.setAttribute('src', videoData.snippet.thumbnails.default.url);

                                    var durationElement = document.createElement('p');
                                    durationElement.textContent = formatDuration(videoData.contentDetails.duration);

                                    var videoContainerElement = document.createElement('div');
                                    videoContainerElement.appendChild(titleElement);
                                    videoContainerElement.appendChild(descriptionElement);
                                    videoContainerElement.appendChild(thumbnailElement);
                                    videoContainerElement.appendChild(durationElement);
                                    videoContainerElement.appendChild(videoElement);

                                    videoFeedElement.appendChild(videoContainerElement);

                                    var videoItem = {
                                    id: video.id,
                                    title: video.title,
                                    description: video.description,
                                    thumbnail: video.thumbnail,
                                    duration: formatDuration(video.duration)
                                    };
                                    videosList.push(videoItem);
                                    }, function(error) {
                                    console.error(error);
                                });
                            })
                            Promise.all(promises).then(function() {
                                console.log(videos);
                                console.log(videosList);
                                onYouTubeIframeAPIReady(videosList); // Pass videosList as an argument
                        });
                    });
                });
            });
            
            function onYouTubeIframeAPIReady(videosList) {

                if (videosList && videosList.length > 0) {
                    player = new YT.Player('player', {
                    height: '360',
                    width: '640',
                    videoId: videosList[0].id,
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });

                } else {
                    console.error('No videos found');
                }
                
            }

            function onPlayerReady(event) {
                // Start playing the video
                event.target.playVideo();
                event.target.setPlaybackQuality('hd720');
                event.target.addEventListener('onStateChange', onPlayerStateChange);
            }

            function onPlayerStateChange(event) {
                if (event.data === YT.PlayerState.ENDED) {
                    event.target.pauseVideo();
                };
                if (event.data === YT.PlayerState.BUFFERING) {
                    var messageElement = document.getElementById('message');

                    if (messageElement) {
                        messageElement.textContent = 'Buffering...';
                        messageElement.style.display = 'block';
                    }
                } else {
                    var messageElement = document.getElementById('message');
                    if (messageElement) {
                        messageElement.style.display = 'none';
                    }  
                };
            }
            
            // Format video duration from ISO 8601 format to hh:mm:ss
            function formatDuration(duration) {
                var match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);

               var hours = (parseInt(match[1]) || 0);
                var minutes = (parseInt(match[2]) || 0);
                var seconds = (parseInt(match[3]) || 0);

                var totalSeconds = (hours * 60 * 60) + (minutes * 60) + seconds;

                var formattedDuration = '';

                if (hours > 0) {
                    formattedDuration += hours + ':';
                }

                if (minutes < 10) {
                    formattedDuration += '0';
                }
                formattedDuration += minutes + ':';

                if (seconds < 10) {
                    formattedDuration += '0';
                }
                formattedDuration += seconds;

                return formattedDuration;
            }
        </script>
        
        <script src="https://www.youtube.com/iframe_api" onload="onYouTubeIframeAPIReady()"></script>
    </section>
</body>
<footer>
    <!-- Add your footer content here -->
</footer>